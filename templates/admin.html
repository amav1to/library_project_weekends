<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .status-badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
        }
        .status-waiting { background-color: #ffc107; color: #000; }
        .status-issued { background-color: #0d6efd; color: #fff; }
        .status-returned { background-color: #198754; color: #fff; }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.075);
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">
                <i class="bi bi-journal-bookmark"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            </span>
            <div>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-house"></i> –ì–ª–∞–≤–Ω–∞—è
                </a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìã –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–¥–∞—á—É –∫–Ω–∏–≥</h2>
            <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm" data-filter="all">–í—Å–µ</button>
                <button class="btn btn-outline-warning btn-sm" data-filter="waiting">–û–∂–∏–¥–∞–Ω–∏–µ</button>
                <button class="btn btn-outline-info btn-sm" data-filter="issued">–í—ã–¥–∞–Ω–æ</button>
                <button class="btn btn-outline-success btn-sm" data-filter="returned">–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ</button>
            </div>
        </div>
        
        {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover" id="requestsTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–ì—Ä—É–ø–ø–∞</th>
                        <th>–ö–Ω–∏–≥–∞</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr data-status="{{ req.status }}">
                        <td>{{ req.id }}</td>
                        <td>{{ req.student.full_name if req.student else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</td>
                        <td>
                            {% if req.student and req.student.group %}
                                {{ req.student.group.name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if req.book %}
                                {{ req.book.name }} ({{ req.book.language }})
                            {% else %}
                                –ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞
                            {% endif %}
                        </td>
                        <td>{{ req.quantity }}</td>
                        <td>{{ req.request_date.strftime('%d.%m.%Y %H:%M') if req.request_date else '-' }}</td>
                        <td>
                            {% if req.status == '–æ–∂–∏–¥–∞–Ω–∏–µ' %}
                                <span class="badge status-badge status-waiting">
                                    <i class="bi bi-clock"></i> –û–∂–∏–¥–∞–Ω–∏–µ
                                </span>
                            {% elif req.status == '–≤—ã–¥–∞–Ω–æ' %}
                                <span class="badge status-badge status-issued">
                                    <i class="bi bi-check-circle"></i> –í—ã–¥–∞–Ω–æ
                                </span>
                            {% elif req.status == '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ' %}
                                <span class="badge status-badge status-returned">
                                    <i class="bi bi-arrow-return-left"></i> –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if req.status == '–æ–∂–∏–¥–∞–Ω–∏–µ' %}
                                <button class="btn btn-success btn-sm action-btn" 
                                    data-action="confirm" 
                                    data-id="{{ req.id }}"
                                    title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-danger btn-sm action-btn"
                                    data-action="reject" 
                                    data-id="{{ req.id }}"
                                    title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% elif req.status == '–≤—ã–¥–∞–Ω–æ' %}
                                <button class="btn btn-primary btn-sm action-btn"
                                    data-action="return" 
                                    data-id="{{ req.id }}"
                                    title="–û—Ç–º–µ—Ç–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç">
                                    <i class="bi bi-arrow-return-left"></i>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> –ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–¥–∞—á—É –∫–Ω–∏–≥ –ø–æ–∫–∞ –Ω–µ—Ç.
        </div>
        {% endif %}
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Ç–µ–∫—Å—Ç -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" id="modalConfirmBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('=== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ –ó–ê–ì–†–£–ñ–ï–ù–ê ===');
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ Bootstrap
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const modalBody = document.getElementById('modalBody');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        
        let currentRequestId = null;
        let currentAction = '';
        
        // 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –¥–µ–π—Å—Ç–≤–∏–π
        document.addEventListener('click', function(event) {
            let button = event.target;
            
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∏–∫–æ–Ω–∫–µ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏
            if (button.tagName === 'I') {
                button = button.closest('button');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            if (button && button.hasAttribute('data-action')) {
                currentAction = button.getAttribute('data-action');
                currentRequestId = button.getAttribute('data-id');
                
                console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É:', currentAction, 'ID:', currentRequestId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤–æ–ø—Ä–æ—Å–æ–º
                if (currentAction === 'confirm') {
                    modalBody.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É –∫–Ω–∏–≥–∏?';
                    modalConfirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É';
                    confirmModal.show();
                } 
                else if (currentAction === 'return') {
                    modalBody.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–Ω–∏–≥—É –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—É—é?';
                    modalConfirmBtn.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç';
                    confirmModal.show();
                }
                else if (currentAction === 'reject') {
                    modalBody.textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–¥–∞—á—É?';
                    modalConfirmBtn.textContent = '–û—Ç–∫–ª–æ–Ω–∏—Ç—å';
                    confirmModal.show();
                }
                
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if (button && button.hasAttribute('data-filter')) {
                const filter = button.getAttribute('data-filter');
                filterRequests(filter);
                return;
            }
        });
        
        // 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        modalConfirmBtn.addEventListener('click', function() {
            if (!currentRequestId || !currentAction) return;
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', currentAction, 'ID:', currentRequestId);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
            let url = '';
            if (currentAction === 'confirm') {
                url = '/admin/confirm-issue/' + currentRequestId;
            } else if (currentAction === 'return') {
                url = '/admin/mark-returned/' + currentRequestId;
            } else if (currentAction === 'reject') {
                url = '/admin/reject-request/' + currentRequestId;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                
                if (data.success) {
                    // –£—Å–ø–µ—à–Ω–æ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    console.log('–£—Å–ø–µ—Ö! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
                    location.reload();
                } else {
                    // –û—à–∏–±–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.error);
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            })
            .finally(() => {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                confirmModal.hide();
            });
        });
        
        // 3. –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function filterRequests(filter) {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä:', filter);
            
            const rows = document.querySelectorAll('#requestsTable tbody tr');
            const statusMap = {
                'all': 'all',
                'waiting': '–æ–∂–∏–¥–∞–Ω–∏–µ',
                'issued': '–≤—ã–¥–∞–Ω–æ',
                'returned': '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ'
            };
            
            const targetStatus = statusMap[filter] || filter;
            
            rows.forEach(row => {
                if (filter === 'all' || row.getAttribute('data-status') === targetStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            console.log('–≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã:');
            console.log('- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:', document.getElementById('confirmModal') ? '–Ω–∞–π–¥–µ–Ω–æ' : '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            console.log('- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π:', document.querySelectorAll('[data-action]').length + ' —à—Ç.');
            console.log('- –°—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ:', document.querySelectorAll('#requestsTable tbody tr').length + ' —à—Ç.');
        });
    </script>
</body>
</html>